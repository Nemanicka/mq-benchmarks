package main

import (
	"context"
	"fmt"
	"time"

	"sync"

	"github.com/redis/go-redis/v9"
)

var ctx = context.Background()
var rdb *redis.Client
var aof *redis.Client
var np *redis.Client

type Object struct {
	Value  string
	Expiry time.Time
	Delta  time.Duration
}

func init() {
	rdb = redis.NewClient(&redis.Options{
		Addr:     "localhost:6400",
		Password: "", // no password set
		DB:       0,  // use default DB
	})

	aof = redis.NewClient(&redis.Options{
		Addr:     "localhost:6401",
		Password: "", // no password set
		DB:       0,  // use default DB
	})

	np = redis.NewClient(&redis.Options{
		Addr:     "localhost:6402",
		Password: "", // no password set
		DB:       0,  // use default DB
	})
}

func writeTest(c *redis.Client, volume int, agent int) {
	for i := 0; i < volume; i++ {
		c.LPush(ctx, fmt.Sprintf("agent%dKey%d", agent, i), fmt.Sprintf("This is awesome message #%d", i))
	}
}

func readTest(c *redis.Client, volume int, agent int) {
	for i := 0; i < volume; i++ {
		c.RPop(ctx, fmt.Sprintf("agent%dKey%d", agent, i))
	}
}

func benchmarkRedis(test func(*redis.Client, int, int), c *redis.Client, concurrency, volume int) {
	start := time.Now()
	var wg sync.WaitGroup
	for i := 0; i < concurrency; i++ {
		wg.Add(1)
		go func() {
			defer wg.Done()
			test(c, volume, i)
		}()
	}
	wg.Wait()
	end := time.Now()
	fmt.Printf("%v\n", end.Sub(start))
}

func main() {

	fmt.Println("Check rdb...")
	concurrency := 100
	volume := 1000

	fmt.Printf("RDB write: ")
	benchmarkRedis(writeTest, rdb, concurrency, volume)

	fmt.Printf("RDB read: ")
	benchmarkRedis(readTest, rdb, concurrency, volume)

	fmt.Printf("AOF write: ")
	benchmarkRedis(writeTest, aof, concurrency, volume)

	fmt.Printf("AOF read: ")
	benchmarkRedis(readTest, aof, concurrency, volume)

	fmt.Printf("NP write: ")
	benchmarkRedis(writeTest, np, concurrency, volume)

	fmt.Printf("NP read: ")
	benchmarkRedis(readTest, np, concurrency, volume)

}
